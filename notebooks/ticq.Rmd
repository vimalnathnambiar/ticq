---
title: "TICQ Report"
subtitle: "Total Ion Current Quality Assessment of Mass Spectrometry Spectral Data"
author: "Vimalnath Nambiar and Shabarinath Nambiar"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_notebook:
    toc: true
    toc_float: true
    toc_depth: 6
    theme: paper
  html_document:
    toc: true
    toc_float: true
    toc_depth: 6
    theme: paper
params:
    input: NULL
    chromatogramRegion: NULL
    targetFile: NULL
    anpcMethodLibrary: NULL
    roundDecimal: NULL
    anonymiserStatus: FALSE
---

# Configuration Parameters {.tabset}
Parameters configured for TICQ assessment.
```{r, echo = FALSE, warning = FALSE, include = FALSE}
library(roxygen2)
library(devtools)
roxygenize("../.")
load_all("../.")

# Load (and install missing) packages
ticq::loadPackage(packageList = c("DT", "dplyr"))

# Input data
# input <- params$input
input <- "/run/media/vimalnathnambiar/WD/data/JSON/barwon/"

# Chromatogram region to splice
# chromatogramRegion <- params$chromatogramRegion
chromatogramRegion <- ticq::configureChromatogramRegion(massCalStart = 0, massCalEnd = 0.3,
                                                        washStart = 5)

# Method / Target Data
targetFile <- params$targetFile
# anpcMethodLibrary <- params$anpcMethodLibrary
anpcMethodLibrary <- "MS-AA-POS"
# roundDecimal <- params$roundDecimal
roundDecimal <- 4

# Anonymise data?
anonymiserStatus <- params$anonymiserStatus

# Clean environment
rm(params)
```

```{r, echo = FALSE, warning = FALSE, include = FALSE}
# Identify path to historical data (In-house ANPC method library-specific)
historicalDataPath <- paste0(getwd(), "/../data/historical/")
if (!is.null(anpcMethodLibrary)) {
  switch(anpcMethodLibrary,
         "MS-AA-POS" = historicalDataPath <- paste0(historicalDataPath, "MS-AA-POS.rds"),
         "MS-HIL-POS" = historicalDataPath <- paste0(historicalDataPath, "MS-HIL-POS.rds"),
         "MS-HIL-NEG" = historicalDataPath <- paste0(historicalDataPath, "MS-HIL-NEG.rds"),
         "MS-RP-POS" = historicalDataPath <- paste0(historicalDataPath, "MS-RP-POS.rds"),
         "MS-RP-NEG" = historicalDataPath <- paste0(historicalDataPath, "MS-RP-NEG.rds")
  )
} else {
  historicalDataPath <- NULL
}

# Extract target m/z from target file or in-house ANPC method library
targetMZ <- ticq::extractTargetMZ(targetFile = targetFile,
                                  anpcMethodLibrary = anpcMethodLibrary,
                                  roundDecimal = roundDecimal)

# Clean environment
rm(targetFile, anpcMethodLibrary)
```

## Input
```{r, echo = FALSE, warning = FALSE}
# Display input path
print(input)
```

## Chromatogram Region
```{r, echo = FALSE, warning = FALSE}
# Display chromatogram regions
print(chromatogramRegion)
```

## Target m/z
```{r, echo = FALSE, warning = FALSE}
# Check if target m/z data is available
if (!is.null(targetMZ)) {
  # Display number of decimal used for precision value rounding
  if (!is.null(roundDecimal)) {
    print(paste("NOTE: Target m/z values rounded to", roundDecimal, "decimal place(s)"))
  } else {
    print("NOTE: Using DEFAULT precision length for target m/z values")
  }

  # Display target m/z data
  DT::datatable(data = targetMZ,
                filter = "top",
                options = list(scrollX = TRUE))
} else {
  print("No available target m/z data")
}
```

# Input Check
Input specified is validated for the presence of JSON file(s) to be extracted and assessed.
```{r, echo = FALSE, warning = FALSE}
# Retrieve file list and display number of JSON files to process
inputFiles <- ticq::retrieveFileList(input = input, fileExtension = "JSON")
print(paste("Number of JSON files to process:", length(inputFiles)))

# Check new sample status
if (length(inputFiles) > 0) {
  newStatus <- TRUE
} else {
  newStatus <- FALSE
  
  # Clean environment
  rm(input, inputFiles)
}
```

# Spectral Data Extraction
Spectral data is extracted from JSON file(s) retrieved from input. 
```{r, echo = FALSE, warning = FALSE}
# Check if there are new samples to process
if (newStatus) {
  # Extract spectral data and metadata
  result <- ticq::extractSpectrum(input = input, inputFiles = inputFiles)
  passedData <- result$passedData
  
  # Check new sample status (and save data if TRUE)
  if (nrow(passedData) != 0) {
    newStatus <- TRUE
    saveRDS(passedData, file = paste0(getwd(), "/../data/raw.rds"))
  } else {
    newStatus <- FALSE
  }
  
  # Display spectral data extraction result
  print(paste("Number of files that failed spectral data extraction:", nrow(result$failedData)))
  if (nrow(result$failedData) != 0) {
    print(DT::datatable(data = result$failedData,
                  filter = "top",
                  options = list(scrollX = TRUE)))
  }
  
  # Clean environment
  rm(input, inputFiles, result)
  invisible(gc())
} else {
  print("Spectral data extraction not performed: No data files available for extraction")
}
```

```{r, echo = FALSE, warning = FALSE, include = FALSE}
# If there are new samples to process
if (newStatus) {
  # Set column names of the extracted data
  sampleID <- "sampleID"
  project <- "project"
  cohort <- "cohort"
  projectCohort <- "projectCohort"
  matrix <- "matrix"
  sampleType <- "sampleType"
  method <- "method"
  instrument <- "instrument"
  plate <- "plate"
  date <- "date"
  time <- "time"
  spectrumCount <- "spectrumCount"
  spectrumIndex <- "spectrum.index"
  msLevel <- "spectrum.msLevel"
  retentionTime <- "spectrum.retentionTime"
  basePeakIntensity <- "spectrum.basePeakIntensity"
  basePeakMZ <- "spectrum.basePeakMZ"
  totalIonCurrent <- "spectrum.totalIonCurrent"
  mzArray <- "spectrum.mzArray"
  intensityArray <- "spectrum.intensityArray"
}
```

```{r, echo = FALSE, warning = FALSE, include = FALSE}
# If there are new samples to process and anonymiser status is TRUE
if (newStatus && anonymiserStatus) {
  # Anonymise sample information
  passedData <- ticq::anonymiseMetadata(data = passedData,
                                        sampleID = sampleID,
                                        project = project,
                                        cohort = cohort,
                                        projectCohort = projectCohort,
                                        method = method,
                                        instrument = instrument,
                                        plate = plate)
}

# Clean environment
rm(anonymiserStatus)
```

# Preliminary Data Check {.tabset}
## Undefined Sample Type Check
Extracted samples are checked for the presence of undefined sample type (based on metadata).
```{r, echo = FALSE, warning = FALSE}
# Check if there are new samples to process
if (newStatus) {
  # Check for undefined sample type
  result <- ticq::checkUndefinedSampleType(data = passedData,
                                           commonColumn = colnames(passedData)[which(colnames(passedData) == sampleID):
                                                                               which(colnames(passedData) == spectrumCount)], 
                                           sampleType = sampleType, 
                                           spectrumCount = spectrumCount)
  
  # Check new sample status
  passedData <- result$passedData
  if (nrow(passedData) == 0) {
    newStatus <- FALSE
  }
  
  # Display undefined sample type check result
  print(paste("Number of samples with undefined sample type:", nrow(result$failedData)))
  if (nrow(result$failedData) != 0) {
    print(DT::datatable(data = result$failedData,
                  filter = "top",
                  options = list(scrollX = TRUE)))
  }
  
  # Clean environment
  rm(result)
  invisible(gc())
} else {
  print("Undefined sample type check not performed: No new samples to analyse")
}
```

## Spectrum Count Check
Spectrum count of samples are checked against a threshold limit of 20% below average spectrum count of all samples (mean).
```{r, echo = FALSE, warning = FALSE}
# Check if there are new samples to process
if (newStatus) {
  # If historical data exists
  if (file.exists(historicalDataPath)) {
    historicalData <- readRDS(historicalDataPath)
    
    # Merge historical data and new data
    passedData <- rbind(historicalData, passedData)
    
    # Clean environment
    rm(historicalData)
    invisible(gc())
  }
  
  # Check spectrum count if comparison with historical data or more than 1 new sample is performed
  if (length(unique(passedData[[sampleID]])) > 1) {
    result <- ticq::checkSpectrumCount(data = passedData, 
                                       commonColumn = colnames(passedData)[which(colnames(passedData) == sampleID):
                                                                           which(colnames(passedData) == spectrumCount)], 
                                       sampleID = sampleID, 
                                       spectrumCount = spectrumCount,
                                       threshold = 20)
  } else {
    print("Spectrum count check not performed: Only one sample to analyse")
    result <- NULL
  }
  
  # If spectrum count check result is NOT NULL
  if (!is.null(result)) {
    # Remove historical data from passed and failed results
    result$passedData <- result$passedData %>%
      dplyr::filter(.data[[projectCohort]] != "Historical")
    
    result$failedData <- result$failedData %>%
      dplyr::filter(.data[[projectCohort]] != "Historical")
    
    # Check new sample status
    passedData <- result$passedData
    if (nrow(passedData) == 0) {
      newStatus <- FALSE
    }
    
    # Display spectrum count check result
    print(paste("Sample size:", result$sampleSize))
    print(paste("Spectrum count (TOTAL):", result$total))
    print(paste("Spectrum count (MEAN):", result$mean))
    print(paste("Threshold limit (20% BELOW MEAN):", result$threshold))
    print(paste("Number of samples with a spectrum count below the threshold limit:", nrow(result$failedData)))
    if (nrow(result$failedData) != 0) {
      print(DT::datatable(data = result$failedData,
                          filter = "top",
                          options = list(scrollX = TRUE)))
    }
  }
  
  # Clean environment
  rm(result)
  invisible(gc())
} else {
  print("Spectrum count check not performed: No new samples to analyse")
}
```

# Sample Types To Be Analysed
```{r, echo = FALSE, warning = FALSE}
# Check if there are new samples to process
if (newStatus) {
  # Extract sample types of new samples
  sampleTypeList <- unique(passedData[[sampleType]])
  print(sampleTypeList)
} else {
  print("No new samples to analyse")
}
```

# Total Ion Chromatogram {.tabset}
Chromatogram overview (Total ion current, TIC vs Retention Time, RT) of each sample type along with 3 chromatographic regions of interest outlined: mass calibration, analyte, and wash region. Chromatogram is plotted using full scan MS level 1 spectral data. 
```{r, echo = FALSE, warning = FALSE}
# Check if there are new samples to process
if (newStatus) {
  # Check if MS level 1 spectral data is available
  if (any(passedData[[msLevel]] == 1)) {
    msStatus <- TRUE
    
    # Filter MS level 1 spectral data for plotting
    plotData <- passedData %>% 
      dplyr::filter(.data[[msLevel]] == 1) %>%
      dplyr::select(all_of(c(colnames(passedData)[which(colnames(passedData) == sampleID):
                                                  which(colnames(passedData) == spectrumCount)],
                             retentionTime, totalIonCurrent)))
    
    # If historical data exists
    if (file.exists(historicalDataPath)) {
      historicalData <- readRDS(historicalDataPath)
      
      # Filter historical data for MS level 1 spectral data
      historicalData <- historicalData %>%
        dplyr::filter(.data[[msLevel]] == 1) %>%
        dplyr::select(all_of(c(colnames(historicalData)[which(colnames(historicalData) == sampleID):
                                                        which(colnames(historicalData) == spectrumCount)],
                               retentionTime, totalIonCurrent)))
      
      # Merge historical data into plot data
      plotData <- rbind(historicalData, plotData)
      
      # Clean environment
      rm(historicalData)
      invisible(gc())
    }
    
    # Set plot variables and labels
    title <- "Total Ion Chromatogram"
    labelX <- "RT"
    labelY <- "TIC"
    shape <- sampleType
    shapeLegend <- "Sample Type"
    
      # Dynamically set colour grouping variable and label
      if (length(unique(plotData[[projectCohort]])) > 1) {s
        colour <- projectCohort
        colourLegend <- "Project"
      } else {
        colour <- plate
        colourLegend <- "Plate"
      }
  } else {
    msStatus <- FALSE
    print("Unable to generate Total Ion Chromatogram: No available MS level 1 spectral data")
  }
} else {
  print("Unable to generate Total Ion Chromatogram: No new samples to analyse")
}
```

## LTR
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("sLTR Plasma", "LTR Plasma",
               "sLTR Serum", "LTR Serum",
               "sLTR Urine", "LTR Urine")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Generate chromatogram plot for each pattern combination that exists
    for (i in unique(sub("sLTR |LTR ", "", pattern))) {
      # If combined pattern exists in sample type list
      tmpPattern <- c(paste("sLTR", i), paste("LTR", i))
      if (any(tmpPattern %in% sampleTypeList)) {
        # Plot chromatogram
        ticq::plotChromatogram(data = plotData %>% 
                                 dplyr::filter(.data[[sampleType]] %in% tmpPattern),
                               x = retentionTime,
                               y = totalIonCurrent,
                               colour = colour,
                               title = title,
                               subtitle = paste("LTR", i),
                               labelX = labelX,
                               labelY = labelY,
                               legend = colourLegend,
                               chromatogramRegion = chromatogramRegion)
      }
      
      # Clean environment
      rm(tmpPattern)
    }
  } else {
    print("No available data")
  }
}
```

## dLTR
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("dLTR Plasma", "dLTR Serum", "dLTR Urine")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Generate chromatogram plot for each pattern that exists
    for (i in pattern) {
      # If pattern exists in sample type list
      if (i %in% sampleTypeList) {
        # Plot chromatogram
        ticq::plotChromatogram(data = plotData %>% 
                                 dplyr::filter(.data[[sampleType]] %in% i),
                               x = retentionTime,
                               y = totalIonCurrent,
                               colour = colour,
                               title = title,
                               subtitle = i,
                               labelX = labelX,
                               labelY = labelY,
                               legend = colourLegend,
                               chromatogramRegion = chromatogramRegion)
      }
    }
  } else {
    print("No available data")
  }
}
```

## PQC
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("PQC Plasma", "PQC Serum", "PQC Urine")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Generate chromatogram plot for each pattern that exists
    for (i in pattern) {
      # If pattern exists in sample type list
      if (i %in% sampleTypeList) {
        # Plot chromatogram
        ticq::plotChromatogram(data = plotData %>% 
                                 dplyr::filter(.data[[sampleType]] %in% i),
                               x = retentionTime,
                               y = totalIonCurrent,
                               colour = colour,
                               title = title,
                               subtitle = i,
                               labelX = labelX,
                               labelY = labelY,
                               legend = colourLegend,
                               chromatogramRegion = chromatogramRegion)
      }
    }
  } else {
    print("No available data")
  }
}
```

## dPQC
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("dPQC Plasma", "dPQC Serum", "dPQC Urine")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Generate chromatogram plot for each pattern that exists
    for (i in pattern) {
      # If pattern exists in sample type list
      if (i %in% sampleTypeList) {
        # Plot chromatogram
        ticq::plotChromatogram(data = plotData %>% 
                                 dplyr::filter(.data[[sampleType]] %in% i),
                               x = retentionTime,
                               y = totalIonCurrent,
                               colour = colour,
                               title = title,
                               subtitle = i,
                               labelX = labelX,
                               labelY = labelY,
                               legend = colourLegend,
                               chromatogramRegion = chromatogramRegion)
      }
    }
  } else {
    print("No available data")
  }
}
```

## QC
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("QC01", "QC02", "QC03", "QC04")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Generate chromatogram plot for each pattern that exists
    for (i in pattern) {
      # If pattern exists in sample type list
      if (i %in% sampleTypeList) {
        # Plot chromatogram
        ticq::plotChromatogram(data = plotData %>% 
                                 dplyr::filter(.data[[sampleType]] %in% i),
                               x = retentionTime,
                               y = totalIonCurrent,
                               colour = colour,
                               title = title,
                               subtitle = i,
                               labelX = labelX,
                               labelY = labelY,
                               legend = colourLegend,
                               chromatogramRegion = chromatogramRegion)
      }
    }
  } else {
    print("No available data")
  }
}
```

## CAL
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("CAL01", "CAL02", "CAL03", "CAL04", "CAL05", "CAL06", "CAL07", "CAL08")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Generate chromatogram plot for each pattern that exists
    for (i in pattern) {
      # If pattern exists in sample type list
      if (i %in% sampleTypeList) {
        # Plot chromatogram
        ticq::plotChromatogram(data = plotData %>% 
                                 dplyr::filter(.data[[sampleType]] %in% i),
                               x = retentionTime,
                               y = totalIonCurrent,
                               colour = colour,
                               title = title,
                               subtitle = i,
                               labelX = labelX,
                               labelY = labelY,
                               legend = colourLegend,
                               chromatogramRegion = chromatogramRegion)
      }
    }
  } else {
    print("No available data")
  }
}
```

## Blank
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("Single Blank", "Double Blank")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Generate chromatogram plot for each pattern that exists
    for (i in pattern) {
      # If pattern exists in sample type list
      if (i %in% sampleTypeList) {
        # Plot chromatogram
        ticq::plotChromatogram(data = plotData %>% 
                                 dplyr::filter(.data[[sampleType]] %in% i),
                               x = retentionTime,
                               y = totalIonCurrent,
                               colour = colour,
                               title = title,
                               subtitle = i,
                               labelX = labelX,
                               labelY = labelY,
                               legend = colourLegend,
                               chromatogramRegion = chromatogramRegion)
      }
    }
  } else {
    print("No available data")
  }
}
```

## Sample
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("Sample Plasma", "Sample Serum", "Sample Urine")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Generate chromatogram plot for each pattern that exists
    for (i in pattern) {
      # If pattern exists in sample type list
      if (i %in% sampleTypeList) {
        # Plot chromatogram
        ticq::plotChromatogram(data = plotData %>% 
                                 dplyr::filter(.data[[sampleType]] %in% i),
                               x = retentionTime,
                               y = totalIonCurrent,
                               colour = colour,
                               title = title,
                               subtitle = i,
                               labelX = labelX,
                               labelY = labelY,
                               legend = colourLegend,
                               chromatogramRegion = chromatogramRegion)
      }
    }
  } else {
    print("No available data")
  }
}
```

## dSample
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("dSample Plasma", "dSample Serum", "dSample Urine")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Generate chromatogram plot for each pattern that exists
    for (i in pattern) {
      # If pattern exists in sample type list
      if (i %in% sampleTypeList) {
        # Plot chromatogram
        ticq::plotChromatogram(data = plotData %>% 
                                 dplyr::filter(.data[[sampleType]] %in% i),
                               x = retentionTime,
                               y = totalIonCurrent,
                               colour = colour,
                               title = title,
                               subtitle = i,
                               labelX = labelX,
                               labelY = labelY,
                               legend = colourLegend,
                               chromatogramRegion = chromatogramRegion)
      }
    }
  } else {
    print("No available data")
  }
  
  # Clean environment
  rm(title, labelX, labelY, pattern, i)
}
```

# Statistical Analysis {.tabset}
The chromatogram regions of interest (mass calibration, analyte, and wash regions) of the samples by their corresponding type using statistical methodologies such as PCA, time series, and violin plot analyses.
```{r, echo = FALSE, warning = FALSE, include = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Splice and sum TIC of chromatogram regions specified
  plotData <- ticq::spliceChromatogramRegion(data = plotData,
                                             commonColumn = colnames(plotData)[which(colnames(plotData) == sampleID):
                                                                               which(colnames(plotData) == spectrumCount)],
                                             spectrumCount = spectrumCount,
                                             chromatogramRegion = chromatogramRegion,
                                             filterBy = retentionTime,
                                             sumBy = totalIonCurrent)
  
  # Set column names of the spliced chromatogram regions
  overallRegion <- "overallRegion"
  prewashRegion <- "prewashRegion"
  massCalRegion <- "massCalRegion"
  analyteRegion <- "analyteRegion"
  washRegion <- "washRegion"
}
```

## Principal Component Analysis (PCA) {.tabset}
PCA provides an overview of the overall sample variance influenced by the 3 chromatogram regions of interest. 
```{r, echo = FALSE, warning = FALSE}
# Check if there are new samples to process and MS level 1 spectral data is available
if (!newStatus) {
  print("Unable to perform Principal Component Analysis: No new samples to analyse")
} else if (!msStatus) {
  print("Unable to perform Principal Component Analysis: No available MS level 1 spectral data")
} else {
  # Set toggles for PCA plot printing
  screePlt <- TRUE
  scoresPlt <- FALSE
  loadingsPlt <- FALSE
  biPlt <- TRUE
}
```

### LTR {.tabset}
#### LTR Plasma
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("sLTR Plasma", "LTR Plasma")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = "LTR Plasma",
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### LTR Serum
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("sLTR Serum", "LTR Serum")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = "LTR Serum",
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### LTR Urine
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("sLTR Urine", "LTR Urine")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = "LTR Urine",
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

### dLTR {.tabset}
#### dLTR Plasma
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("dLTR Plasma")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### dLTR Serum
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("dLTR Serum")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### dLTR Urine
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("dLTR Urine")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

### PQC {.tabset}
#### PQC Plasma
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("PQC Plasma")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### PQC Serum
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("PQC Serum")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### PQC Urine
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("PQC Urine")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

### dPQC {.tabset}
#### dPQC Plasma
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("dPQC Plasma")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### dPQC Serum
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("dPQC Serum")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### dPQC Urine
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("dPQC Urine")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

### QC {.tabset}
#### QC01
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("QC01")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### QC02
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("QC02")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### QC03
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("QC03")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### QC04
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("QC04")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

### CAL {.tabset}
#### CAL01
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("CAL01")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### CAL02
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("CAL02")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### CAL03
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("CAL03")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### CAL04
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("CAL04")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### CAL05
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("CAL05")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### CAL06
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("CAL06")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### CAL07
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("CAL07")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### CAL08
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("CAL08")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

### Blank {.tabset}
#### Single Blank
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("Single Blank")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### Double Blank
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("Double Blank")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = pattern,
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

### Sample {.tabset}
#### Sample Plasma
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("sLTR Plasma", "LTR Plasma", "Sample Plasma")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = "Sample Plasma",
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### Sample Serum
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("sLTR Serum", "LTR Serum", "Sample Serum")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = "Sample Serum",
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### Sample Urine
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("sLTR Urine", "LTR Urine", "Sample Urine")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = "Sample Urine",
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

### dSample {.tabset}
#### dSample Plasma
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("dLTR Plasma", "dSample Plasma")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = "dSample Plasma",
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### dSample Serum
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("dLTR Serum", "dSample Serum")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = "dSample Serum",
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
}
```

#### dSample Urine
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("dLTR Urine", "dSample Urine")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Plot PCA
    ticq::plotPCA(data = plotData %>%
                    dplyr::filter(.data[[sampleType]] %in% pattern),
                  startIDX = which(colnames(plotData) == massCalRegion),
                  colour = colour,
                  shape = shape,
                  subtitle = "dSample Plasma",
                  colourLegend = colourLegend,
                  shapeLegend = shapeLegend,
                  screePlt = screePlt,
                  scoresPlt = scoresPlt,
                  loadingsPlt = loadingsPlt,
                  biPlt = biPlt)
  } else {
    print("No available data")
  }
  
  # Clean environment
  rm(screePlt, scoresPlt, loadingsPlt, biPlt, pattern)
}
```

## Time Series Analysis {.tabset}
Time series analysis focuses on the prewash region (mass calibration + analyte). This analysis provides a temporal trendline of the processed samples and assesses the combined performance of mass calibration references, ISTD and endogenous analytes in the region. A report is generated highlighting the samples that have a significant deviation (1st and 2nd standard deviation) from the average mean performance.
```{r, echo = FALSE, warning = FALSE}
# Check if there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set plot variables and labels
  labelX <- "Date"
  labelY <- "Prewash Region (TIC)"
  boundary <- "sd"
  xTick <- FALSE
  
  # Data frame to store analysis result
  analysisResult_TS <- data.frame()
} else if (!newStatus) {
  print("Unable to perform Time Series Analysis: No new samples to analyse")
} else if (!msStatus) {
  print("Unable to perform Time Series Analysis: No available MS level 1 spectral data")
}
```

### LTR
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("sLTR Plasma", "LTR Plasma",
               "sLTR Serum", "LTR Serum",
               "sLTR Urine", "LTR Urine")

  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Generate time series plot for each pattern combination that exists
    for (i in unique(sub("sLTR |LTR ", "", pattern))) {
      # If combined pattern exists in sample type list
      tmpPattern <- c(paste("sLTR", i), paste("LTR", i))
      if (any(tmpPattern %in% sampleTypeList)) {
        # Plot time series
        result <- ticq::plotTimeSeries(data = plotData %>%
                                         dplyr::filter(.data[[sampleType]] %in% tmpPattern),
                                       x = date,
                                       y = prewashRegion,
                                       colour = colour,
                                       shape = shape,
                                       subtitle = paste("LTR", i),
                                       labelX = labelX,
                                       labelY = labelY,
                                       colourLegend = colourLegend,
                                       shapeLegend = shapeLegend,
                                       boundary = boundary,
                                       xTick = xTick)

        # Append analysis result
        analysisResult_TS <- rbind(analysisResult_TS, result)
      }

      # Clean environment
      rm(tmpPattern)
    }
  } else {
    print("No available data")
  }
}
```

### dLTR
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("dLTR Plasma", "dLTR Serum", "dLTR Urine")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Generate time series plot for each pattern combination that exists
    for (i in pattern) {
      # If pattern exists in sample type list
      if (i %in% sampleTypeList) {
        # Plot time series
        result <- ticq::plotTimeSeries(data = plotData %>% 
                                         dplyr::filter(.data[[sampleType]] %in% i),
                                       x = date,
                                       y = prewashRegion,
                                       colour = colour,
                                       shape = shape,
                                       subtitle = i,
                                       labelX = labelX,
                                       labelY = labelY,
                                       colourLegend = colourLegend,
                                       shapeLegend = shapeLegend,
                                       boundary = boundary,
                                       xTick = xTick)
        
        # Append analysis result
        analysisResult_TS <- rbind(analysisResult_TS, result)
      }
    }
  } else {
    print("No available data")
  }
}
```

### PQC
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("PQC Plasma", "PQC Serum", "PQC Urine")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Generate time series plot for each pattern combination that exists
    for (i in pattern) {
      # If pattern exists in sample type list
      if (i %in% sampleTypeList) {
        # Plot time series
        result <- ticq::plotTimeSeries(data = plotData %>% 
                                         dplyr::filter(.data[[sampleType]] %in% i),
                                       x = date,
                                       y = prewashRegion,
                                       colour = colour,
                                       shape = shape,
                                       subtitle = i,
                                       labelX = labelX,
                                       labelY = labelY,
                                       colourLegend = colourLegend,
                                       shapeLegend = shapeLegend,
                                       boundary = boundary,
                                       xTick = xTick)
        
        # Append analysis result
        analysisResult_TS <- rbind(analysisResult_TS, result)
      }
    }
  } else {
    print("No available data")
  }
}
```

### dPQC
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("dPQC Plasma", "dPQC Serum", "dPQC Urine")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Generate time series plot for each pattern combination that exists
    for (i in pattern) {
      # If pattern exists in sample type list
      if (i %in% sampleTypeList) {
        # Plot time series
        result <- ticq::plotTimeSeries(data = plotData %>% 
                                         dplyr::filter(.data[[sampleType]] %in% i),
                                       x = date,
                                       y = prewashRegion,
                                       colour = colour,
                                       shape = shape,
                                       subtitle = i,
                                       labelX = labelX,
                                       labelY = labelY,
                                       colourLegend = colourLegend,
                                       shapeLegend = shapeLegend,
                                       boundary = boundary,
                                       xTick = xTick)
        
        # Append analysis result
        analysisResult_TS <- rbind(analysisResult_TS, result)
      }
    }
  } else {
    print("No available data")
  }
}
```

### QC
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("QC01", "QC02", "QC03", "QC04")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Generate time series plot for each pattern combination that exists
    for (i in pattern) {
      # If pattern exists in sample type list
      if (i %in% sampleTypeList) {
        # Plot time series
        result <- ticq::plotTimeSeries(data = plotData %>% 
                                         dplyr::filter(.data[[sampleType]] %in% i),
                                       x = date,
                                       y = prewashRegion,
                                       colour = colour,
                                       shape = shape,
                                       subtitle = i,
                                       labelX = labelX,
                                       labelY = labelY,
                                       colourLegend = colourLegend,
                                       shapeLegend = shapeLegend,
                                       boundary = boundary,
                                       xTick = xTick)
        
        # Append analysis result
        analysisResult_TS <- rbind(analysisResult_TS, result)
      }
    }
  } else {
    print("No available data")
  }
}
```

### CAL
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("CAL01", "CAL02", "CAL03", "CAL04", "CAL05", "CAL06", "CAL07", "CAL08")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Generate time series plot for each pattern combination that exists
    for (i in pattern) {
      # If pattern exists in sample type list
      if (i %in% sampleTypeList) {
        # Plot time series
        result <- ticq::plotTimeSeries(data = plotData %>% 
                                         dplyr::filter(.data[[sampleType]] %in% i),
                                       x = date,
                                       y = prewashRegion,
                                       colour = colour,
                                       shape = shape,
                                       subtitle = i,
                                       labelX = labelX,
                                       labelY = labelY,
                                       colourLegend = colourLegend,
                                       shapeLegend = shapeLegend,
                                       boundary = boundary,
                                       xTick = xTick)
        
        # Append analysis result
        analysisResult_TS <- rbind(analysisResult_TS, result)
      }
    }
  } else {
    print("No available data")
  }
}
```

### Blank
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("Single Blank", "Double Blank")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Generate time series plot for each pattern combination that exists
    for (i in pattern) {
      # If pattern exists in sample type list
      if (i %in% sampleTypeList) {
        # Plot time series
        result <- ticq::plotTimeSeries(data = plotData %>% 
                                         dplyr::filter(.data[[sampleType]] %in% i),
                                       x = date,
                                       y = prewashRegion,
                                       colour = colour,
                                       shape = shape,
                                       subtitle = i,
                                       labelX = labelX,
                                       labelY = labelY,
                                       colourLegend = colourLegend,
                                       shapeLegend = shapeLegend,
                                       boundary = boundary,
                                       xTick = xTick)
        
        # Append analysis result
        analysisResult_TS <- rbind(analysisResult_TS, result)
      }
    }
  } else {
    print("No available data")
  }
}
```

### Sample
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("Sample Plasma", "Sample Serum", "Sample Urine")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Generate time series plot for each pattern combination that exists
    for (i in pattern) {
      # If pattern exists in sample type list
      if (i %in% sampleTypeList) {
        # Set patterns to search for long term references to compare against
        tmpPattern <- sub("Sample ", "", i)
        tmpPattern <- c(paste("sLTR", tmpPattern), paste("LTR", tmpPattern))
        
        # Calculate mean and standard deviations (sd and sd2) of long term references if applicable
        tmpReferenceData <- plotData %>%
          dplyr::filter(.data[[sampleType]] %in% tmpPattern)
        if (nrow(tmpReferenceData) > 1) {
          boundaryValue <- ticq::generateStat(data = tmpReferenceData[[prewashRegion]]) %>%
            dplyr::select(mean, sd, sd2) %>%
            as.list()
        } else {
          boundaryValue <- 0
        }
                
        # Plot time series
        result <- ticq::plotTimeSeries(data = plotData %>% 
                                         dplyr::filter(.data[[sampleType]] %in% c(tmpPattern, i)),
                                       x = date,
                                       y = prewashRegion,
                                       colour = colour,
                                       shape = shape,
                                       subtitle = i,
                                       labelX = labelX,
                                       labelY = labelY,
                                       colourLegend = colourLegend,
                                       shapeLegend = shapeLegend,
                                       boundary = boundary,
                                       boundaryValue = boundaryValue,
                                       xTick = xTick) %>%
          dplyr::filter(.data[[sampleType]] %in% i)
        
        # Append analysis result
        analysisResult_TS <- rbind(analysisResult_TS, result)
        
        # Clean environment
        rm(tmpPattern, tmpReferenceData, boundaryValue)
        invisible(gc())
      }
    }
  } else {
    print("No available data")
  }
}
```

### dSample
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # Set patterns to check
  pattern <- c("dSample Plasma", "dSample Serum", "dSample Urine")
  
  # Check if any of the patterns exists in sample type list
  if (any(pattern %in% sampleTypeList)) {
    # Generate time series plot for each pattern combination that exists
    for (i in pattern) {
      # If pattern exists in sample type list
      if (i %in% sampleTypeList) {
        # Set patterns to search for long term references to compare against
        tmpPattern <- sub("dSample ", "", i)
        tmpPattern <- c(paste("dLTR", tmpPattern))
        
        # Calculate mean and standard deviations (sd and sd2) of long term references if applicable
        tmpReferenceData <- plotData %>%
          dplyr::filter(.data[[sampleType]] %in% tmpPattern)
        if (nrow(tmpReferenceData) > 1) {
          boundaryValue <- ticq::generateStat(data = tmpReferenceData[[prewashRegion]]) %>%
            dplyr::select(mean, sd, sd2) %>%
            as.list()
        } else {
          boundaryValue <- 0
        }
                
        # Plot time series
        result <- ticq::plotTimeSeries(data = plotData %>% 
                                         dplyr::filter(.data[[sampleType]] %in% c(tmpPattern, i)),
                                       x = date,
                                       y = prewashRegion,
                                       colour = colour,
                                       shape = shape,
                                       subtitle = i,
                                       labelX = labelX,
                                       labelY = labelY,
                                       colourLegend = colourLegend,
                                       shapeLegend = shapeLegend,
                                       boundary = boundary,
                                       boundaryValue = boundaryValue,
                                       xTick = xTick) %>%
          dplyr::filter(.data[[sampleType]] %in% i)
        
        # Append analysis result
        analysisResult_TS <- rbind(analysisResult_TS, result)
        
        # Clean environment
        rm(tmpPattern, tmpReferenceData, boundaryValue)
        invisible(gc())
      }
    }
  } else {
    print("No available data")
  }
  
  # Clean environment
  rm(labelX, labelY, boundary, xTick, pattern, i, result)
  invisible(gc())
}
```

# Report {.tabset}
## Time Series Analysis
The report highlights the deviation significance of the samples from the average mean performance of the prewash region.

**RED** = Very High or Very Low  
**YELLOW** = Low or High    
**GREEN** = Normal    
```{r, echo = FALSE, warning = FALSE}
# If there are new samples to process and MS level 1 spectral data is available
if (newStatus && msStatus) {
  # If result table is not empty
  if (ncol(analysisResult_TS) != 0) {
    print(DT::datatable(data = analysisResult_TS %>%
                          dplyr::select(all_of(colnames(analysisResult_TS)[which(colnames(analysisResult_TS) == sampleID):
                                                                           which(colnames(analysisResult_TS) == spectrumCount)]), 
                                        prewashRegion, sampleRange) %>%
                          dplyr::filter(.data[[projectCohort]] != "Historical"),
                        filter = "top",
                        options = list(scrollX = TRUE)) %>%
            DT::formatStyle("sampleRange",
                            target = "row",
                            backgroundColor = styleEqual(c("Very Low", "Low", "Normal", "High", "Very High"), 
                                                         c("red", "yellow", "green", "yellow", "red"))))
  } else {
    print("Unable to display results - No available data")
  }
  
  # Clean environment
  rm(analysisResult_TS)
  invisible(gc())
}
```

